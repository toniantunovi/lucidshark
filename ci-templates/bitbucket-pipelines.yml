# LucidScan Bitbucket Pipelines Template
# Copy this to your bitbucket-pipelines.yml or merge with your existing config

image: ghcr.io/voldeq/lucidscan:latest

definitions:
  steps:
    - step: &lucidscan-full
        name: LucidScan Security Scan
        script:
          - lucidscan --all --format table
        artifacts:
          - lucidscan-report.json

    - step: &lucidscan-sca
        name: LucidScan SCA Scan
        script:
          - lucidscan --sca

    - step: &lucidscan-sast
        name: LucidScan SAST Scan
        script:
          - lucidscan --sast

    - step: &lucidscan-iac
        name: LucidScan IaC Scan
        script:
          - lucidscan --iac

    - step: &lucidscan-blocking
        name: LucidScan Security Gate
        script:
          - lucidscan --all --fail-on high
        # This step will fail the build if high/critical issues are found

pipelines:
  default:
    - step: *lucidscan-full

  pull-requests:
    '**':
      - step: *lucidscan-full

  branches:
    main:
      - step: *lucidscan-blocking
    master:
      - step: *lucidscan-blocking

  # Parallel scanning for faster feedback
  custom:
    parallel-scan:
      - parallel:
          - step: *lucidscan-sca
          - step: *lucidscan-sast
          - step: *lucidscan-iac

    # Container scanning (requires image to be built first)
    container-scan:
      - step:
          name: Build Docker Image
          script:
            - docker build -t myapp:$BITBUCKET_COMMIT .
          services:
            - docker
      - step:
          name: Scan Container Image
          script:
            - lucidscan --container --image myapp:$BITBUCKET_COMMIT
          services:
            - docker
